version: '2.1'
orbs:
  eb: circleci/aws-elastic-beanstalk@1.0.0

jobs:
  build:
    machine: true
    resource_class: medium
    steps:
      - checkout
#      - run:
#          name: Building Docker
#          command: docker build . -t $IMAGE_NAME --no-cache --build-arg RAILS_MASTER_KEY=${RAILS_MASTER_KEY}
#
#      - run:
#          name: Publish Docker Image to Docker Hub
#          command: |
#            echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
#            docker push $IMAGE_NAME:latest

      - run:
          name: Updating Dockerrun.aws.json
          command: |
            mkdir build
            cp ./Dockerrun.aws.json ./build

#          environment-name: etanol-prod
#          label: version-<<pipeline.number>>
#          app-dir: ./build
#          platform-version: docker
      - persist_to_workspace:
          root: /tmp/workspace
          paths: ./Dockerrun.aws.json

  deploy:
    docker:
      - image: 'cimg/base:stable'
    steps:
      - eb/setup
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Deploying to Elastic Bean Stalk
          command: |
            eb deploy
workflows:
  production:
    jobs:
      - build:
          filters:
            branches:
              only: main
      - deploy:
          filters:
            branches:
              only: main
          requires:
            - build
